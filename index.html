<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ترس هوم - تسجيل الدخول</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@200;300;400;500;700;800;900&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Tajawal", sans-serif;
        background: linear-gradient(
          135deg,
          #f0fdf4 0%,
          #dcfce7 25%,
          #bbf7d0 50%,
          #86efac 75%,
          #4ade80 100%
        );
        min-height: 100vh;
      }

      .login-container {
        backdrop-filter: blur(20px);
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.1);
      }

      .form-input {
        transition: all 0.3s ease;
        border: 2px solid #e5e7eb;
      }

      .form-input:focus {
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        outline: none;
        transform: translateY(-1px);
      }

      .form-input:hover {
        border-color: #9ca3af;
      }

      .btn-login {
        background: linear-gradient(135deg, #065f46, #10b981);
        transition: all 0.3s ease;
      }

      .btn-login:hover {
        background: linear-gradient(135deg, #047857, #059669);
        transform: translateY(-2px);
        box-shadow: 0 10px 20px -5px rgba(16, 185, 129, 0.3);
      }

      .btn-login:active {
        transform: translateY(0);
      }

      .logo-container {
        background: linear-gradient(135deg, #065f46, #10b981);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .input-icon {
        transition: all 0.3s ease;
      }

      .form-group:focus-within .input-icon {
        color: #10b981;
        transform: scale(1.1);
      }

      .animated-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        opacity: 0.1;
      }

      .floating-shape {
        position: absolute;
        border-radius: 50%;
        background: linear-gradient(135deg, #10b981, #059669);
        animation: float 6s ease-in-out infinite;
      }

      .floating-shape:nth-child(1) {
        width: 80px;
        height: 80px;
        top: 20%;
        left: 10%;
        animation-delay: 0s;
      }

      .floating-shape:nth-child(2) {
        width: 120px;
        height: 120px;
        top: 60%;
        right: 15%;
        animation-delay: 2s;
      }

      .floating-shape:nth-child(3) {
        width: 60px;
        height: 60px;
        top: 80%;
        left: 20%;
        animation-delay: 4s;
      }

      .floating-shape:nth-child(4) {
        width: 100px;
        height: 100px;
        top: 10%;
        right: 30%;
        animation-delay: 1s;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px) rotate(0deg);
        }
        50% {
          transform: translateY(-20px) rotate(180deg);
        }
      }

      .pulse-ring {
        position: absolute;
        border: 3px solid #10b981;
        border-radius: 50%;
        animation: pulse-ring 2s cubic-bezier(0.455, 0.03, 0.515, 0.955)
          infinite;
      }

      @keyframes pulse-ring {
        0% {
          transform: scale(0.8);
          opacity: 1;
        }
        100% {
          transform: scale(2.4);
          opacity: 0;
        }
      }

      .loading-spinner {
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top: 3px solid #ffffff;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .welcome-message {
        background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        border: 1px solid #bbf7d0;
      }

      .error-message {
        background: linear-gradient(135deg, #fef2f2, #fee2e2);
        border: 1px solid #fca5a5;
        color: #dc2626;
      }

      .success-message {
        background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        border: 1px solid #bbf7d0;
        color: #16a34a;
      }

      .logout-message {
        background: linear-gradient(135deg, #fefbf2, #fef3c7);
        border: 1px solid #fbbf24;
        color: #d97706;
      }

      /* RTL Adjustments */
      [dir="rtl"] .text-left {
        text-align: right !important;
      }

      [dir="rtl"] .ml-2 {
        margin-left: 0 !important;
        margin-right: 0.5rem !important;
      }

      [dir="rtl"] .mr-2 {
        margin-right: 0 !important;
        margin-left: 0.5rem !important;
      }

      [dir="rtl"] .pl-12 {
        padding-left: 0 !important;
        padding-right: 3rem !important;
      }

      [dir="rtl"] .left-4 {
        left: auto !important;
        right: 1rem !important;
      }

      [dir="rtl"] .right-4 {
        right: auto !important;
        left: 1rem !important;
      }
    </style>
  </head>
  <body>
    <!-- Animated Background -->
    <div class="animated-bg">
      <div class="floating-shape"></div>
      <div class="floating-shape"></div>
      <div class="floating-shape"></div>
      <div class="floating-shape"></div>
    </div>

    <!-- Login Container -->
    <div class="min-h-screen flex items-center justify-center px-4 py-12">
      <div class="login-container max-w-md w-full rounded-2xl p-8 relative">
        <!-- Pulse Ring Effect -->
        <div
          class="pulse-ring"
          style="width: 100px; height: 100px; top: -20px; right: -20px"
        ></div>

        <!-- Logo and Title -->
        <div class="text-center mb-8">
          <div class="logo-container text-4xl font-bold mb-4 relative">
            <i class="fas fa-home text-5xl mb-2 block"></i>
            ترس هوم
          </div>
          <h2 class="text-2xl font-bold text-gray-900 mb-2">
            مرحباً بك مرة أخرى
          </h2>
          <p class="text-gray-600">سجل دخولك للوصول إلى لوحة التحكم</p>
        </div>

        <!-- Welcome Message -->
        <div
          id="welcome-message"
          class="welcome-message rounded-lg p-4 mb-6 text-center hidden"
        >
          <i class="fas fa-info-circle ml-2 text-green-600"></i>
          <span class="text-green-800"
            >يرجى إدخال بيانات تسجيل الدخول الخاصة بك</span
          >
        </div>

        <!-- Logout Message -->
        <div
          id="logout-message"
          class="logout-message rounded-lg p-4 mb-6 text-center hidden"
        >
          <i class="fas fa-sign-out-alt ml-2"></i>
          <span class="text-orange-800"
            >تم تسجيل خروجك بنجاح، يرجى تسجيل الدخول مرة أخرى</span
          >
        </div>

        <!-- Error Message -->
        <div
          id="error-message"
          class="error-message rounded-lg p-4 mb-6 text-center hidden"
        >
          <i class="fas fa-exclamation-circle ml-2"></i>
          <span id="error-text"></span>
        </div>

        <!-- Success Message -->
        <div
          id="success-message"
          class="success-message rounded-lg p-4 mb-6 text-center hidden"
        >
          <i class="fas fa-check-circle ml-2"></i>
          <span id="success-text"></span>
        </div>

        <!-- Login Form -->
        <form id="login-form" class="space-y-6">
          <!-- Email Field -->
          <div class="form-group">
            <label
              for="email"
              class="block text-sm font-medium text-gray-700 mb-2"
            >
              <i class="fas fa-envelope ml-2"></i>
              البريد الإلكتروني
            </label>
            <div class="relative">
              <input
                type="email"
                id="email"
                name="email"
                required
                class="form-input w-full px-4 py-3 pl-12 rounded-lg focus:ring-2 focus:ring-green-500"
                placeholder="أدخل بريدك الإلكتروني"
                autocomplete="email"
              />
              <i
                class="input-icon fas fa-at absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"
              ></i>
            </div>
          </div>

          <!-- Password Field -->
          <div class="form-group">
            <label
              for="password"
              class="block text-sm font-medium text-gray-700 mb-2"
            >
              <i class="fas fa-lock ml-2"></i>
              كلمة المرور
            </label>
            <div class="relative">
              <input
                type="password"
                id="password"
                name="password"
                required
                class="form-input w-full px-4 py-3 pl-12 rounded-lg focus:ring-2 focus:ring-green-500"
                placeholder="أدخل كلمة المرور"
                autocomplete="current-password"
              />
              <i
                class="input-icon fas fa-lock absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"
              ></i>
            </div>
          </div>

          <!-- Login Button -->
          <button
            type="submit"
            id="login-btn"
            class="btn-login w-full py-3 px-4 rounded-lg text-white font-semibold text-lg transition-all duration-300 flex items-center justify-center"
          >
            <span id="login-btn-text">تسجيل الدخول</span>
            <div id="login-spinner" class="loading-spinner mr-3 hidden"></div>
          </button>
        </form>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      // Import Firebase modules
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        get,
        child,
      } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

      // Firebase configuration (updated with your new config)
      const firebaseConfig = {
        apiKey: "AIzaSyBmnVjPWw6gtQ0tC6Jvd2JqLFPxvczWSC4",
        authDomain: "jordanhomes-96a0c.firebaseapp.com",
        databaseURL:
          "https://jordanhomes-96a0c-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "jordanhomes-96a0c",
        storageBucket: "jordanhomes-96a0c.firebasestorage.app",
        messagingSenderId: "650418495613",
        appId: "1:650418495613:web:77bdff8abc5c42b8c3d114",
        measurementId: "G-M8TMG1GF1C",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);

      // Make database available globally
      window.firebaseDB = database;
      window.firebaseRef = ref;
      window.firebaseGet = get;
      window.firebaseChild = child;

      // Check if Firebase loaded properly
      if (!database) {
        console.error("Firebase database failed to load");
        document.addEventListener("DOMContentLoaded", function () {
          Swal.fire({
            title: "خطأ في النظام",
            text: "فشل في تحميل قاعدة البيانات، يرجى تحديث الصفحة",
            icon: "error",
            confirmButtonColor: "#10b981",
            confirmButtonText: "تحديث الصفحة",
          }).then((result) => {
            if (result.isConfirmed) {
              window.location.reload();
            }
          });
        });
      }
    </script>

    <script>
      // Enhanced cookie management with localStorage fallback
      function setCookie(name, value, days = 7) {
        try {
          const expires = new Date(Date.now() + days * 864e5).toUTCString();

          // For localhost/file protocol, use simple cookie without SameSite/Secure
          if (
            window.location.protocol === "file:" ||
            window.location.hostname === "localhost" ||
            window.location.hostname === "127.0.0.1"
          ) {
            document.cookie = `${name}=${encodeURIComponent(
              value
            )}; expires=${expires}; path=/`;
          } else {
            document.cookie = `${name}=${encodeURIComponent(
              value
            )}; expires=${expires}; path=/; SameSite=Lax`;
          }

          // Also store in localStorage as fallback
          try {
            const storageData = {
              value: value,
              expires: Date.now() + days * 864e5,
            };
            localStorage.setItem(name, JSON.stringify(storageData));
            console.log(`Stored ${name} in localStorage as fallback`);
          } catch (localStorageError) {
            console.warn("localStorage not available:", localStorageError);
          }

          // Verify cookie was set successfully
          setTimeout(() => {
            const verifyValue = getCookie(name);
            if (verifyValue === value) {
              console.log(`Cookie '${name}' set and verified successfully`);
            } else {
              console.warn(
                `Cookie '${name}' verification failed. Expected: ${value.substring(
                  0,
                  50
                )}..., Got: ${verifyValue.substring(0, 50)}...`
              );
            }
          }, 100);

          return true;
        } catch (error) {
          console.error("Error setting cookie:", error);
          return false;
        }
      }

      function getCookie(name) {
        try {
          // First try to get from cookies
          const cookieValue = document.cookie.split("; ").reduce((r, v) => {
            const parts = v.split("=");
            return parts[0] === name ? decodeURIComponent(parts[1]) : r;
          }, "");

          if (cookieValue) {
            return cookieValue;
          }

          // Fallback to localStorage
          const localStorageData = localStorage.getItem(name);
          if (localStorageData) {
            const parsed = JSON.parse(localStorageData);
            if (parsed.expires > Date.now()) {
              console.log(`Retrieved ${name} from localStorage fallback`);
              return parsed.value;
            } else {
              // Expired, remove it
              localStorage.removeItem(name);
            }
          }

          return "";
        } catch (error) {
          console.error("Error getting cookie:", error);
          return "";
        }
      }

      function deleteCookie(name) {
        try {
          setCookie(name, "", -1);
          // Also remove from localStorage
          localStorage.removeItem(name);
          console.log(`Removed ${name} from both cookies and localStorage`);
        } catch (error) {
          console.error("Error deleting cookie:", error);
        }
      }

      // Clear all authentication data - NEW FUNCTION
      function clearAllAuthData() {
        console.log("Clearing all authentication data...");

        // Clear all authentication-related cookies
        deleteCookie("jordan_home_auth");
        deleteCookie("jordan_home_user");

        // Clear any additional auth-related data from localStorage
        try {
          localStorage.removeItem("jordan_home_auth");
          localStorage.removeItem("jordan_home_user");
          localStorage.removeItem("user_session");
          localStorage.removeItem("auth_token");
          // Clear any other auth-related items you might have
        } catch (error) {
          console.error("Error clearing localStorage:", error);
        }

        // Clear session storage as well
        try {
          sessionStorage.clear();
        } catch (error) {
          console.error("Error clearing sessionStorage:", error);
        }

        console.log("All authentication data cleared successfully");
      }

      // Enhanced token generation with additional security
      function generateAuthToken(user) {
        try {
          if (!user || !user.email) {
            throw new Error("Invalid user data for token generation");
          }

          // Create a more secure token with additional data
          const tokenData = {
            id: user.id,
            email: user.email,
            username: user.username || "user",
            timestamp: Date.now(),
            expires: Date.now() + 7 * 24 * 60 * 60 * 1000, // 7 days
            sessionId:
              Math.random().toString(36).substring(2, 15) +
              Math.random().toString(36).substring(2, 15), // Random session ID
            userAgent: navigator.userAgent.substring(0, 50), // First 50 chars of user agent for basic validation
          };

          // Simple base64 encoding (in production, use proper JWT with signing)
          const token = btoa(JSON.stringify(tokenData));

          console.log(
            "Auth token generated successfully for user:",
            user.email
          );
          return token;
        } catch (error) {
          console.error("Token generation error:", error);
          throw new Error("Failed to generate authentication token");
        }
      }

      // Modified function - now always clears auth instead of checking
      function handlePageLoad() {
        console.log("Login page loaded - clearing authentication data...");

        // Check if there was existing authentication
        const existingToken = getCookie("jordan_home_auth");
        const hadAuth = existingToken && existingToken.length > 0;

        // Always clear authentication data when login page is accessed
        clearAllAuthData();

        // Show appropriate message based on whether user had existing auth
        if (hadAuth) {
          console.log("Previous authentication found and cleared");
          showLogoutMessage();
        } else {
          console.log("No previous authentication found");
          // Show welcome message after a short delay
          setTimeout(() => {
            showWelcomeMessage();
          }, 500);
        }
      }

      // UI Management Functions
      function showWelcomeMessage() {
        hideAllMessages();
        document.getElementById("welcome-message").classList.remove("hidden");
      }

      function showLogoutMessage() {
        hideAllMessages();
        document.getElementById("logout-message").classList.remove("hidden");

        // Auto-hide logout message after 3 seconds and show welcome message
        setTimeout(() => {
          showWelcomeMessage();
        }, 3000);
      }

      function showErrorMessage(message) {
        hideAllMessages();
        document.getElementById("error-text").textContent = message;
        document.getElementById("error-message").classList.remove("hidden");
      }

      function showSuccessMessage(message) {
        hideAllMessages();
        document.getElementById("success-text").textContent = message;
        document.getElementById("success-message").classList.remove("hidden");
      }

      function hideAllMessages() {
        document.getElementById("welcome-message").classList.add("hidden");
        document.getElementById("logout-message").classList.add("hidden");
        document.getElementById("error-message").classList.add("hidden");
        document.getElementById("success-message").classList.add("hidden");
      }

      function setLoading(isLoading) {
        const btn = document.getElementById("login-btn");
        const btnText = document.getElementById("login-btn-text");
        const spinner = document.getElementById("login-spinner");

        if (isLoading) {
          btn.disabled = true;
          btn.classList.add("opacity-75", "cursor-not-allowed");
          btnText.textContent = "جاري تسجيل الدخول...";
          spinner.classList.remove("hidden");
        } else {
          btn.disabled = false;
          btn.classList.remove("opacity-75", "cursor-not-allowed");
          btnText.textContent = "تسجيل الدخول";
          spinner.classList.add("hidden");
        }
      }

      // Authentication function against Firebase Realtime Database
      async function authenticateUser(email, password) {
        try {
          const dbRef = window.firebaseRef(window.firebaseDB);
          const snapshot = await window.firebaseGet(
            window.firebaseChild(dbRef, "users")
          );

          if (snapshot.exists()) {
            const users = snapshot.val();

            // Search through all users
            for (const userId in users) {
              const user = users[userId];
              if (user.email === email && user.password === password) {
                return {
                  success: true,
                  user: {
                    id: userId,
                    email: user.email,
                    username: user.username || "مستخدم",
                  },
                };
              }
            }

            return {
              success: false,
              error: "البريد الإلكتروني أو كلمة المرور غير صحيحة",
            };
          } else {
            return {
              success: false,
              error: "لا توجد بيانات مستخدمين في النظام",
            };
          }
        } catch (error) {
          console.error("Authentication error:", error);
          return {
            success: false,
            error: "حدث خطأ أثناء الاتصال بقاعدة البيانات",
          };
        }
      }

      // Login form handler
      async function handleLogin(event) {
        event.preventDefault();

        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;

        // Validation
        if (!email || !password) {
          showErrorMessage("يرجى إدخال البريد الإلكتروني وكلمة المرور");
          return;
        }

        if (!/\S+@\S+\.\S+/.test(email)) {
          showErrorMessage("يرجى إدخال بريد إلكتروني صحيح");
          return;
        }

        setLoading(true);
        hideAllMessages();

        try {
          // Authenticate against Firebase Realtime Database
          const authResult = await authenticateUser(email, password);

          if (authResult.success) {
            const user = authResult.user;

            // Generate and store auth token with enhanced security
            try {
              console.log("Starting token generation for user:", user);

              const authToken = generateAuthToken(user);

              console.log("Generated auth token length:", authToken.length);

              // Store authentication token
              const authCookieSet = setCookie("jordan_home_auth", authToken);
              console.log("Auth cookie set result:", authCookieSet);

              // Store user info
              const userInfo = {
                id: user.id,
                email: user.email,
                username: user.username,
                loginTime: Date.now(),
              };

              const userInfoString = JSON.stringify(userInfo);
              const userCookieSet = setCookie(
                "jordan_home_user",
                userInfoString
              );
              console.log("User cookie set result:", userCookieSet);

              // Verify cookies are accessible
              setTimeout(() => {
                const storedAuth = getCookie("jordan_home_auth");
                const storedUser = getCookie("jordan_home_user");
                console.log(
                  "Stored auth cookie:",
                  storedAuth
                    ? "Found (length: " + storedAuth.length + ")"
                    : "Not found"
                );
                console.log(
                  "Stored user cookie:",
                  storedUser ? "Found" : "Not found"
                );
                console.log("All cookies:", document.cookie);
              }, 200);

              // Log successful authentication
              console.log("User authenticated successfully:", user.email);
              console.log("Auth token generated and stored in cookies");

              showSuccessMessage(
                `مرحباً ${user.username}! جاري التوجه إلى الصفحة الرئيسية...`
              );

              // Redirect to home page after success message
              setTimeout(() => {
                console.log("Redirecting to home.html...");
                window.location.href = "home.html";
              }, 2000);
            } catch (tokenError) {
              console.error("Token generation/storage error:", tokenError);
              showErrorMessage("حدث خطأ في حفظ بيانات تسجيل الدخول");
            }
          } else {
            showErrorMessage(authResult.error);
          }
        } catch (error) {
          console.error("Login error:", error);
          showErrorMessage("حدث خطأ غير متوقع أثناء تسجيل الدخول");
        } finally {
          setLoading(false);
        }
      }

      // Initialize page with error handling
      document.addEventListener("DOMContentLoaded", function () {
        try {
          // Always clear authentication and handle page load
          handlePageLoad();

          // Attach event listeners with error handling
          const loginForm = document.getElementById("login-form");
          if (loginForm) {
            loginForm.addEventListener("submit", handleLogin);
          } else {
            console.error("Login form not found");
          }

          // Enhanced form interactions with error handling
          const inputs = document.querySelectorAll(".form-input");
          inputs.forEach((input) => {
            input.addEventListener("focus", function () {
              if (this.parentElement) {
                this.parentElement.classList.add("focused");
              }
            });

            input.addEventListener("blur", function () {
              if (this.parentElement) {
                this.parentElement.classList.remove("focused");
              }
            });

            // Real-time validation
            input.addEventListener("input", function () {
              if (this.type === "email" && this.value) {
                if (!/\S+@\S+\.\S+/.test(this.value)) {
                  this.classList.add("border-red-300");
                  this.classList.remove("border-green-300");
                } else {
                  this.classList.add("border-green-300");
                  this.classList.remove("border-red-300");
                }
              }
            });
          });

          // Enter key support
          document.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              const loginBtn = document.getElementById("login-btn");
              if (loginBtn && !loginBtn.disabled) {
                const loginForm = document.getElementById("login-form");
                if (loginForm) {
                  const submitEvent = new Event("submit", { cancelable: true });
                  loginForm.dispatchEvent(submitEvent);
                }
              }
            }
          });
        } catch (initError) {
          console.error("Initialization error:", initError);
        }
      });

      // Handle browser back/forward navigation
      window.addEventListener("pageshow", function (event) {
        // This event fires when page is loaded from cache (back button)
        if (event.persisted) {
          console.log("Page loaded from cache (back button) - clearing auth");
          handlePageLoad();
        }
      });

      // Additional event to handle browser navigation
      window.addEventListener("focus", function () {
        // When user returns to this tab/window, ensure auth is cleared
        console.log("Window focus - ensuring auth is cleared");
        const existingToken = getCookie("jordan_home_auth");
        if (existingToken && existingToken.length > 0) {
          clearAllAuthData();
          showLogoutMessage();
        }
      });
    </script>
  </body>
</html>
